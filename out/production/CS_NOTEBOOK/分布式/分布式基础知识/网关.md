# 一、意义

**网关一般都会提供请求转发、安全认证（身份/权限认证）、流量控制、负载均衡、容灾、日志、监控这些功能**



综上：请求过滤

- RPC协议转成HTTP：内部开发中，以RPC协议暴露给内部服务，当外部需要这个接口的时候将RPC转成HTTP
- 请求路由：根据请求上下文将请求路由到对应的接口。
- 统一鉴权：鉴权操作不涉及到业务逻辑，那么可以在网关层进行处理，不用下层到业务逻辑
- 统一监控：网关是外部服务的入口，可以监控数据，比如入参出参，链路时间
- 流量监控，熔断降级

统一API网关

- 统一服务接入

- 节约资源

  

# 二、网关系统

1、kong：openrestry

2、Netflix zuul

# 三、统一网关设计

## 1、异步化请求

（用少量的机器接入更多的服务），提高吞吐量

- Tomcat/Jetty+NIO+servlet3
- Netty+NIO：Netty每秒30w+的吞吐量，但是Netty需要自己处理Http协议

对于网关是HTTP请求场景比较多的情况可以采用Servlet，毕竟有更加成熟的处理HTTP协议。如果更加重视吞吐量那么可以采用Netty。

### 1.1 全链路异步

去的请求利用rpc异步支持进行异步请求

![截屏2020-07-29 下午5.55.06](/Users/yangxinlin/Desktop/截屏2020-07-29 下午5.55.06.png)



## 2、链式处理

责任链式模式：避免请求发送者与接收者耦合在一起，让多个对象都有可能接收请求，将这些对象连接成一条链，并且沿着这条链传递请求，直到有对象处理它为止。

网关设计：

prefilters：前置过滤器，用来处理一些公共的业务，比如统一鉴权，统一限流，熔断降级，缓存处理等，并且提供业务方扩展

routingFilters：用来处理一些泛化调用，主要是做协议的转换，请求的路由工作

postfilters：后置过滤器，主要用来做结果的处理，日志打点，记录时间等等

errorfilters：用来处理调用异常的情况



## 3、业务隔离

### 3.1信号量隔离

信号量隔离只是限制了总的并发数，服务还是主线程进行同步调用。这个隔离如果远程调用超时依然会影响主线程，从而会影响其他业务。因此，如果只是想限制某个服务的总并发调用量或者调用的服务不涉及远程调用的话，可以使用轻量级的信号量来实现

### 3.2 线程池隔离

不同业务之间通过不同的线程池进行隔离，就算业务接口出现了问题由于线程池已经进行了隔离那么也不会影响其他业务

但是会出现资源受限问题

### 3.3 集群隔离

单独申请一个集群或者多个集群，通过机器进行隔离

### 3.4 请求限流

一般限流分为集群限流和单机限流:

- 利用统一存储保存当前流量的情况，一般可以采用Redis，这个一般会有一些性能损耗。
- 单机限流:限流每台机器我们可以直接利用Guava的令牌桶去做，由于没有远程调用性能消耗较小。

### 3.5 熔断降级

sentinel hystrix

### 3.6 泛化应用

一些通信协议的转换

![截屏2020-07-29 下午6.12.24](/Users/yangxinlin/Desktop/截屏2020-07-29 下午6.12.24.png)

（形成映射）

### 3.7 管理平台

# 四、总结

![截屏2020-07-29 下午6.13.17](/Users/yangxinlin/Desktop/截屏2020-07-29 下午6.13.17.png)

